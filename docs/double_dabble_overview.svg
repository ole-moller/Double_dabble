<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 880" font-family="Helvetica, Arial, sans-serif">
  <defs>
    <marker id="arrow" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="10" markerHeight="7" orient="auto-start-auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#334155"/>
    </marker>
    <marker id="arrow-red" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="10" markerHeight="7" orient="auto-start-auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#dc2626"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1000" height="880" rx="12" fill="#f8fafc"/>

  <!-- Title bar -->
  <rect x="0" y="0" width="1000" height="56" rx="12" fill="#1e293b"/>
  <rect x="0" y="24" width="1000" height="32" fill="#1e293b"/>
  <text x="500" y="36" text-anchor="middle" fill="white" font-size="22" font-weight="bold">tt_um_ole_double_dabble</text>
  <text x="988" y="36" text-anchor="end" fill="#94a3b8" font-size="11">8-bit Binary to BCD  |  7-Segment Display</text>

  <!-- ==================== I/O MAPPING SECTION ==================== -->
  <text x="30" y="88" fill="#1e293b" font-size="16" font-weight="bold">I/O Mapping</text>

  <!-- Module outer box -->
  <rect x="220" y="100" width="560" height="230" rx="8" fill="white" stroke="#94a3b8" stroke-width="2.5"/>
  <!-- Module header bar -->
  <rect x="220" y="100" width="560" height="34" rx="8" fill="#1e293b"/>
  <rect x="220" y="118" width="560" height="16" fill="#1e293b"/>
  <text x="500" y="123" text-anchor="middle" fill="white" font-size="14" font-weight="bold">tt_um_ole_double_dabble</text>

  <!-- Internal block: Double Dabble -->
  <rect x="240" y="148" width="200" height="80" rx="6" fill="#dbeafe" stroke="#2563eb" stroke-width="1.5"/>
  <text x="340" y="174" text-anchor="middle" fill="#1e40af" font-size="12" font-weight="bold">Double Dabble</text>
  <text x="340" y="192" text-anchor="middle" fill="#1e40af" font-size="11">Combinational</text>
  <text x="340" y="208" text-anchor="middle" fill="#1e40af" font-size="11">BCD Conversion</text>

  <!-- Internal block: Clock Divider -->
  <rect x="240" y="240" width="200" height="40" rx="6" fill="#e0e7ff" stroke="#6366f1" stroke-width="1.5"/>
  <text x="340" y="265" text-anchor="middle" fill="#4338ca" font-size="11" font-weight="bold">Clock Divider (clk / 4)</text>

  <!-- Internal block: FSM -->
  <rect x="460" y="148" width="155" height="80" rx="6" fill="#dcfce7" stroke="#16a34a" stroke-width="1.5"/>
  <text x="537" y="172" text-anchor="middle" fill="#166534" font-size="12" font-weight="bold">Display FSM</text>
  <text x="537" y="190" text-anchor="middle" fill="#166534" font-size="11">State Machine</text>
  <text x="537" y="206" text-anchor="middle" fill="#166534" font-size="11">+ bin_change</text>

  <!-- Internal block: 7-seg decoder -->
  <rect x="460" y="240" width="155" height="40" rx="6" fill="#fef9c3" stroke="#ca8a04" stroke-width="1.5"/>
  <text x="537" y="265" text-anchor="middle" fill="#854d0e" font-size="11" font-weight="bold">7-Segment Decoder</text>

  <!-- Internal arrows -->
  <line x1="440" y1="180" x2="458" y2="180" stroke="#475569" stroke-width="1.5" marker-end="url(#arrow)"/>
  <text x="448" y="172" text-anchor="middle" fill="#475569" font-size="9">bcd</text>
  <line x1="537" y1="228" x2="537" y2="238" stroke="#475569" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="440" y1="260" x2="458" y2="260" stroke="#475569" stroke-width="1.5" marker-end="url(#arrow)"/>
  <text x="448" y="254" text-anchor="middle" fill="#475569" font-size="9">en</text>

  <!-- Input ports (left side) -->
  <rect x="40" y="160" width="160" height="30" rx="5" fill="#dbeafe" stroke="#2563eb" stroke-width="2"/>
  <text x="120" y="180" text-anchor="middle" fill="#1e40af" font-size="13" font-weight="bold">ui_in[7:0]</text>
  <text x="120" y="152" text-anchor="middle" fill="#64748b" font-size="10">Binary input (0-255)</text>
  <line x1="200" y1="175" x2="218" y2="175" stroke="#2563eb" stroke-width="2" marker-end="url(#arrow)"/>

  <rect x="40" y="218" width="160" height="30" rx="5" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
  <text x="120" y="238" text-anchor="middle" fill="#4338ca" font-size="13" font-weight="bold">clk</text>
  <line x1="200" y1="233" x2="218" y2="233" stroke="#6366f1" stroke-width="2" marker-end="url(#arrow)"/>

  <rect x="40" y="270" width="160" height="30" rx="5" fill="#e0e7ff" stroke="#6366f1" stroke-width="2"/>
  <text x="120" y="290" text-anchor="middle" fill="#4338ca" font-size="13" font-weight="bold">rst_n</text>
  <text x="120" y="310" text-anchor="middle" fill="#64748b" font-size="10">Active-low reset</text>
  <line x1="200" y1="285" x2="218" y2="285" stroke="#6366f1" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Output ports (right side) -->
  <rect x="800" y="160" width="170" height="30" rx="5" fill="#dcfce7" stroke="#16a34a" stroke-width="2"/>
  <text x="885" y="180" text-anchor="middle" fill="#166534" font-size="13" font-weight="bold">uo_out[7:0]</text>
  <line x1="780" y1="175" x2="798" y2="175" stroke="#16a34a" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="808" y="206" fill="#475569" font-size="10">[7] = separator (decimal point)</text>
  <text x="808" y="220" fill="#475569" font-size="10">[6:0] = segments (gfedcba)</text>

  <rect x="800" y="240" width="170" height="30" rx="5" fill="#dcfce7" stroke="#16a34a" stroke-width="2"/>
  <text x="885" y="260" text-anchor="middle" fill="#166534" font-size="13" font-weight="bold">uio_out[7:0]</text>
  <line x1="780" y1="255" x2="798" y2="255" stroke="#16a34a" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="808" y="286" fill="#475569" font-size="10">[7:4] = BCD tens digit</text>
  <text x="808" y="300" fill="#475569" font-size="10">[3:0] = BCD ones digit</text>

  <!-- ==================== COMBINATIONAL SECTION ==================== -->
  <text x="30" y="356" fill="#1e293b" font-size="16" font-weight="bold">Double Dabble Algorithm (Combinational)</text>

  <rect x="30" y="368" width="940" height="140" rx="8" fill="#eff6ff" stroke="#93c5fd" stroke-width="1.5"/>

  <text x="50" y="394" fill="#1e40af" font-size="12" font-weight="bold">8 unrolled iterations (generate loop):</text>

  <!-- Stage boxes -->
  <rect x="50" y="406" width="92" height="54" rx="6" fill="white" stroke="#3b82f6" stroke-width="2"/>
  <text x="96" y="426" text-anchor="middle" fill="#1e40af" font-size="11" font-weight="bold">Stage 0</text>
  <text x="96" y="442" text-anchor="middle" fill="#64748b" font-size="9">bcd=000</text>
  <text x="96" y="454" text-anchor="middle" fill="#64748b" font-size="9">+ bin[7]</text>

  <line x1="142" y1="433" x2="162" y2="433" stroke="#334155" stroke-width="1.5" marker-end="url(#arrow)"/>

  <rect x="162" y="406" width="92" height="54" rx="6" fill="white" stroke="#3b82f6" stroke-width="2"/>
  <text x="208" y="426" text-anchor="middle" fill="#1e40af" font-size="11" font-weight="bold">Stage 1</text>
  <text x="208" y="442" text-anchor="middle" fill="#64748b" font-size="9">add3 if>=5</text>
  <text x="208" y="454" text-anchor="middle" fill="#64748b" font-size="9">shift + bin[6]</text>

  <line x1="254" y1="433" x2="274" y2="433" stroke="#334155" stroke-width="1.5" marker-end="url(#arrow)"/>

  <rect x="274" y="406" width="92" height="54" rx="6" fill="white" stroke="#3b82f6" stroke-width="2"/>
  <text x="320" y="426" text-anchor="middle" fill="#1e40af" font-size="11" font-weight="bold">Stage 2</text>
  <text x="320" y="442" text-anchor="middle" fill="#64748b" font-size="9">add3 if>=5</text>
  <text x="320" y="454" text-anchor="middle" fill="#64748b" font-size="9">shift + bin[5]</text>

  <line x1="366" y1="433" x2="382" y2="433" stroke="#94a3b8" stroke-width="1.5" stroke-dasharray="4,3"/>
  <text x="398" y="437" fill="#94a3b8" font-size="16" font-weight="bold">...</text>
  <line x1="414" y1="433" x2="430" y2="433" stroke="#94a3b8" stroke-width="1.5" stroke-dasharray="4,3"/>

  <rect x="430" y="406" width="92" height="54" rx="6" fill="white" stroke="#3b82f6" stroke-width="2"/>
  <text x="476" y="426" text-anchor="middle" fill="#1e40af" font-size="11" font-weight="bold">Stage 7</text>
  <text x="476" y="442" text-anchor="middle" fill="#64748b" font-size="9">add3 if>=5</text>
  <text x="476" y="454" text-anchor="middle" fill="#64748b" font-size="9">shift + bin[0]</text>

  <line x1="522" y1="433" x2="542" y2="433" stroke="#334155" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- Result box -->
  <rect x="542" y="406" width="165" height="54" rx="6" fill="#1e40af" stroke="#1e3a8a" stroke-width="2"/>
  <text x="624" y="426" text-anchor="middle" fill="white" font-size="12" font-weight="bold">bcd[11:0]</text>
  <text x="624" y="444" text-anchor="middle" fill="#bfdbfe" font-size="10">[11:8]  [7:4]  [3:0]</text>
  <text x="624" y="456" text-anchor="middle" fill="#93c5fd" font-size="9">hund.   tens   ones</text>

  <!-- Per-nibble note -->
  <rect x="725" y="406" width="230" height="54" rx="6" fill="white" stroke="#3b82f6" stroke-width="1" stroke-dasharray="5,3"/>
  <text x="840" y="424" text-anchor="middle" fill="#475569" font-size="11" font-weight="bold">Per nibble at each stage:</text>
  <text x="840" y="440" text-anchor="middle" fill="#64748b" font-size="10">if (nibble >= 5) nibble += 3</text>
  <text x="840" y="456" text-anchor="middle" fill="#64748b" font-size="10">then left-shift all, inject next bit</text>

  <!-- Example -->
  <text x="50" y="490" fill="#475569" font-size="11">Example: bin = 167 (10100111)</text>
  <text x="340" y="490" fill="#1e40af" font-size="11" font-weight="bold">bcd = 0001 0110 0111  (1, 6, 7)</text>

  <!-- ==================== STATE MACHINE SECTION ==================== -->
  <text x="30" y="534" fill="#1e293b" font-size="16" font-weight="bold">Display State Machine (Sequential, clk/4)</text>

  <rect x="30" y="546" width="940" height="325" rx="8" fill="#f0fdf4" stroke="#86efac" stroke-width="1.5"/>

  <!-- Timing note box -->
  <rect x="540" y="558" width="410" height="48" rx="6" fill="white" stroke="#16a34a" stroke-width="1.5"/>
  <text x="745" y="577" text-anchor="middle" fill="#166534" font-size="12" font-weight="bold">Timing: 4 base clk cycles per state</text>
  <text x="745" y="594" text-anchor="middle" fill="#475569" font-size="10">Full display cycle = 16 clk cycles (IDLE + HUNDREDS + TENS + ONES)</text>

  <!-- 7-segment display illustration -->
  <rect x="55" y="558" width="52" height="72" rx="5" fill="#1e293b" stroke="#475569" stroke-width="1"/>
  <!-- a (top) -->    <rect x="66" y="564" width="28" height="5" rx="2" fill="#22c55e"/>
  <!-- b (top-R) -->  <rect x="92" y="568" width="5" height="20" rx="2" fill="#22c55e"/>
  <!-- c (bot-R) -->  <rect x="92" y="594" width="5" height="20" rx="2" fill="#22c55e"/>
  <!-- d (bottom) --> <rect x="66" y="614" width="28" height="5" rx="2" fill="#22c55e"/>
  <!-- e (bot-L) -->  <rect x="63" y="594" width="5" height="20" rx="2" fill="#22c55e"/>
  <!-- f (top-L) -->  <rect x="63" y="568" width="5" height="20" rx="2" fill="#22c55e"/>
  <!-- g (middle) --> <rect x="66" y="590" width="28" height="5" rx="2" fill="#22c55e"/>
  <!-- dp -->         <circle cx="103" cy="619" r="4" fill="#f59e0b"/>
  <text x="81" y="646" text-anchor="middle" fill="#475569" font-size="10">gfedcba + dp</text>

  <!-- Reset label -->
  <text x="195" y="574" text-anchor="middle" fill="#dc2626" font-size="12" font-weight="bold">rst_n = 0</text>
  <text x="195" y="590" text-anchor="middle" fill="#dc2626" font-size="11">or bin_change</text>
  <line x1="195" y1="594" x2="195" y2="650" stroke="#dc2626" stroke-width="2" marker-end="url(#arrow-red)"/>

  <!-- ====== STATE: IDLE ====== -->
  <rect x="130" y="656" width="130" height="80" rx="40" fill="#fefce8" stroke="#f59e0b" stroke-width="3"/>
  <text x="195" y="682" text-anchor="middle" fill="#92400e" font-size="14" font-weight="bold">IDLE</text>
  <text x="195" y="700" text-anchor="middle" fill="#a16207" font-size="10">separator = 1</text>
  <text x="195" y="714" text-anchor="middle" fill="#a16207" font-size="10">segments = off</text>

  <!-- IDLE -> HUNDREDS -->
  <line x1="260" y1="696" x2="340" y2="696" stroke="#334155" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="300" y="688" text-anchor="middle" fill="#475569" font-size="10" font-weight="bold">clk4_en</text>

  <!-- ====== STATE: HUNDREDS ====== -->
  <rect x="342" y="656" width="140" height="80" rx="40" fill="#eff6ff" stroke="#2563eb" stroke-width="3"/>
  <text x="412" y="682" text-anchor="middle" fill="#1e40af" font-size="14" font-weight="bold">HUNDREDS</text>
  <text x="412" y="700" text-anchor="middle" fill="#3b82f6" font-size="10">bcd[11:8]</text>
  <text x="412" y="714" text-anchor="middle" fill="#3b82f6" font-size="10">on 7-seg</text>

  <!-- HUNDREDS -> TENS -->
  <line x1="482" y1="696" x2="552" y2="696" stroke="#334155" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="517" y="688" text-anchor="middle" fill="#475569" font-size="10" font-weight="bold">clk4_en</text>

  <!-- ====== STATE: TENS ====== -->
  <rect x="554" y="656" width="130" height="80" rx="40" fill="#f5f3ff" stroke="#7c3aed" stroke-width="3"/>
  <text x="619" y="682" text-anchor="middle" fill="#5b21b6" font-size="14" font-weight="bold">TENS</text>
  <text x="619" y="700" text-anchor="middle" fill="#7c3aed" font-size="10">bcd[7:4]</text>
  <text x="619" y="714" text-anchor="middle" fill="#7c3aed" font-size="10">on 7-seg</text>

  <!-- TENS -> ONES -->
  <line x1="684" y1="696" x2="754" y2="696" stroke="#334155" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="719" y="688" text-anchor="middle" fill="#475569" font-size="10" font-weight="bold">clk4_en</text>

  <!-- ====== STATE: ONES ====== -->
  <rect x="756" y="656" width="130" height="80" rx="40" fill="#f0fdf4" stroke="#16a34a" stroke-width="3"/>
  <text x="821" y="682" text-anchor="middle" fill="#166534" font-size="14" font-weight="bold">ONES</text>
  <text x="821" y="700" text-anchor="middle" fill="#16a34a" font-size="10">bcd[3:0]</text>
  <text x="821" y="714" text-anchor="middle" fill="#16a34a" font-size="10">on 7-seg</text>

  <!-- ONES -> IDLE (curved path underneath) -->
  <path d="M 821 736 C 821 800 195 800 195 736" fill="none" stroke="#334155" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="508" y="792" text-anchor="middle" fill="#475569" font-size="10" font-weight="bold">clk4_en</text>

  <!-- bin_change dashed red arrows back to IDLE -->
  <path d="M 412 656 C 412 630 270 630 230 652" fill="none" stroke="#dc2626" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#arrow-red)"/>
  <path d="M 619 656 C 619 622 310 622 232 648" fill="none" stroke="#dc2626" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#arrow-red)"/>
  <path d="M 821 656 C 821 616 350 616 234 646" fill="none" stroke="#dc2626" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#arrow-red)"/>

  <!-- Legend -->
  <rect x="55" y="828" width="250" height="30" rx="4" fill="white" stroke="#e2e8f0" stroke-width="1"/>
  <line x1="70" y1="843" x2="100" y2="843" stroke="#334155" stroke-width="2"/>
  <text x="108" y="847" fill="#475569" font-size="10">Normal transition</text>
  <line x1="180" y1="843" x2="210" y2="843" stroke="#dc2626" stroke-width="1.5" stroke-dasharray="6,3"/>
  <text x="218" y="847" fill="#dc2626" font-size="10">Reset / bin_change</text>

</svg>
